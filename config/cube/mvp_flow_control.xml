<?xml version="1.0" encoding="utf-8" ?>

<flow>

    <spec name="control">
        <annotation>
        </annotation>

        <inputs>
        </inputs>

        <outputs>
            <o alias="ax" annotation="ax"/>
            <o alias="ay" annotation="ay"/>
            <o alias="az" annotation="az"/>
            <o alias="wx" annotation="wx"/>
            <o alias="wy" annotation="wy"/>
            <o alias="wz" annotation="wz"/>

            <o alias="roll"/>
            <o alias="pitch"/>
            <o alias="yaw"/>

            <o alias="manc_lon"/>
            <o alias="manc_thr"/>
            <o alias="manc_rud"/>

            <o alias="arm" annotation="arm"/>
        </outputs>

        <params>
        </params>
    </spec>

    <functions>
        <f name="zero" by_spec="core.source.constant">
            <param alias="value">0.0</param>
        </f>

        <!-- navigation -->
        <f name="imu1" by_spec="cube.sensors.icm20948"/>


        <f name="zero" by_spec="core.source.constant">
            <param alias="value">0.0</param>
        </f>

        <f name="roll0" by_spec="core.source.constant">
            <param alias="value">0.0</param>
        </f>
        <f name="pitch0" by_spec="core.source.constant">
            <param alias="value">0.0</param>
        </f>
        <f name="yaw0" by_spec="core.source.constant">
            <param alias="value">0.0</param>
        </f>

        <f name="initial_euler" by_spec="core.quat.from_euler">
            <in alias="roll">roll0/output</in>
            <in alias="pitch">pitch0/output</in>
            <in alias="yaw">yaw0/output</in>
        </f>

        <!-- <f name="bias_calib_proto" by_spec="core.filter.mvng_av">
            <in alias="i1">imu1/wx</in>
            <in alias="i2">imu1/wy</in>
            <in alias="i3">imu1/wz</in>
        </f> -->

        <f name="wx_biased" by_spec="core.math.sub">
            <in alias="input0">imu1/wx</in>
            <in alias="input1">zero</in>
        </f>

        <f name="wy_biased" by_spec="core.math.sub">
            <in alias="input0">imu1/wy</in>
            <in alias="input1">zero</in>
        </f>

        <f name="wz_biased" by_spec="core.math.sub">
            <in alias="input0">imu1/wz</in>
            <in alias="input1">zero</in>
        </f>

        <f name="integrate_att" by_spec="core.quat.prop">
            <in alias="wx">wx_biased/output</in>
            <in alias="wy">wy_biased/output</in>
            <in alias="wz">wz_biased/output</in>
            <in alias="q0">initial_euler/q</in>
            <in alias="qN">norm_att_quat/q</in>
        </f>

        <f name="norm_att_quat" by_spec="core.quat.norm">
            <in alias="q">integrate_att/q</in>
        </f>

        <f name="to_euler" by_spec="core.quat.to_euler">
            <in alias="q">integrate_att/q</in>
        </f>

        <!-- control -->
        <f name="half" by_spec="core.source.constant">
            <param alias="value">0.5</param>
        </f>

        <f name="rc" by_spec="cube.io.rc"/>

        <f name="sine" by_spec="core.source.sin">
            <param alias="period">0.5</param>
        </f>

        <f name="arm_comp" by_spec="core.math.lt">
            <in alias="input0">half/output</in>
            <in alias="input1">rc/rc_channel5</in>
        </f>

        <f name="io" by_spec="cube.io.pwm">
            <in alias="pwm_channel1">rc/rc_channel1</in>
            <in alias="pwm_channel2">rc/rc_channel2</in>
            <in alias="pwm_channel3">rc/rc_channel3</in>
            <in alias="pwm_channel4">rc/rc_channel4</in>
            <in alias="pwm_channel5">rc/rc_channel5</in>
            <in alias="pwm_channel6">rc/rc_channel6</in>
            <in alias="pwm_channel7">rc/rc_channel7</in>
            <in alias="pwm_channel8">rc/rc_channel8</in>
            <in alias="arm">arm_comp/output</in>
        </f>
    </functions>

    <link_outputs>
        <link alias="ax">imu1/ax</link>
        <link alias="ay">imu1/ay</link>
        <link alias="az">imu1/az</link>
        <link alias="wx">wx_biased/output</link>
        <link alias="wy">wy_biased/output</link>
        <link alias="wz">wz_biased/output</link>
        <link alias="arm">arm_comp/output</link>

        <link alias="roll">to_euler/roll</link>
        <link alias="pitch">to_euler/pitch</link>
        <link alias="yaw">to_euler/yaw</link>

        <link alias="manc_lat">rc/rc_channel1</link>
        <link alias="manc_lon">rc/rc_channel2</link>
        <link alias="manc_thr">rc/rc_channel3</link>
        <link alias="manc_rud">rc/rc_channel4</link>
    </link_outputs>

</flow>
